
input {
  beats {
    port => 5044
    ssl => true
    ssl_certificate => "/usr/share/logstash/config/certs/logstash/logstash.crt"
    ssl_key => "/usr/share/logstash/config/certs/logstash/logstash.key"
    ssl_certificate_authorities => ["/usr/share/logstash/config/certs/ca/ca.crt"]
    ssl_verify_mode => "force_peer"
  }
}

filter {
  # JSON log parse et (Filebeat'ten gelen message field'ı JSON olabilir)
  if [message] =~ /^\{/ {
    json {
      source => "message"
      target => "log_details"
    }
  } else {
    # Eğer JSON değilse, direkt message'ı kullan
    mutate {
      add_field => { "log_details" => {} }
    }
  }

  # Log details'ten field'ları çıkar
  if [log_details][message] {
    mutate {
      add_field => { "formatted_message" => "%{[log_details][message]}" }
    }
  } else if [message] {
    mutate {
      add_field => { "formatted_message" => "%{message}" }
    }
  }

  # Timestamp'i düzelt
  if [log_details][@timestamp] {
    date {
      match => [ "[log_details][@timestamp]", "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'", "yyyy-MM-dd'T'HH:mm:ss.SSSZ", "ISO8601" ]
      target => "@timestamp"
    }
  }

  # Thread ve logger bilgilerini ekle
  if [log_details][thread_name] {
    mutate {
      add_field => { "thread_name" => "%{[log_details][thread_name]}" }
    }
  }
  
  if [log_details][logger_name] {
    mutate {
      add_field => { "logger_name" => "%{[log_details][logger_name]}" }
    }
  }

  # Application name'i field'lardan al veya logger_name'den çıkar
  if [fields][service] {
    mutate {
      add_field => { "application_name" => "%{[fields][service]}" }
    }
  } else if [logger_name] =~ /com\.elastic\.monitoring/ {
    mutate {
      add_field => { "application_name" => "monitoring-app" }
    }
  } else if [fields][application] {
    mutate {
      add_field => { "application_name" => "%{[fields][application]}" }
    }
  }

  # Environment bilgisini ekle
  if [fields][env] {
    mutate {
      add_field => { "environment" => "%{[fields][env]}" }
    }
  }

  # Log level'i normalize et
  if [log_details][level] {
    mutate {
      add_field => { "log_level" => "%{[log_details][level]}" }
      uppercase => [ "log_level" ]
    }
  } else if [level] {
    mutate {
      add_field => { "log_level" => "%{level}" }
      uppercase => [ "log_level" ]
    }
  }

  # Parse HTTP request details if present
  if [formatted_message] =~ /Request URL:/ {
    grok {
      match => { "formatted_message" => "Request URL: %{URI:request_url}" }
    }
  }

  # Parse response status if present
  if [formatted_message] =~ /Response status:/ {
    grok {
      match => { "formatted_message" => "Response status: %{NUMBER:response_status:int}" }
    }
  }

  # Handle stack traces
  if [formatted_message] =~ /\tat / {
    grok {
      match => { "formatted_message" => "(?m)%{JAVACLASS:exception_class}: %{GREEDYDATA:error_message}(\n\tat %{JAVACLASS:stack_class}\.%{WORD:stack_method}\(%{GREEDYDATA:stack_file}\))+" }
    }
  }

  # Add log level color coding
  if [log_level] == "ERROR" {
    mutate {
      add_field => { "level_color" => "red" }
      add_tag => [ "error" ]
    }
  } else if [log_level] == "WARN" {
    mutate {
      add_field => { "level_color" => "yellow" }
      add_tag => [ "warning" ]
    }
  } else if [log_level] == "INFO" {
    mutate {
      add_field => { "level_color" => "green" }
      add_tag => [ "info" ]
    }
  } else if [log_level] == "DEBUG" {
    mutate {
      add_field => { "level_color" => "blue" }
      add_tag => [ "debug" ]
    }
  }

  # Host metadata ekle
  if [host][name] {
    mutate {
      add_field => { "hostname" => "%{[host][name]}" }
    }
  }

  # Clean up gereksiz fields
  mutate {
    remove_field => [ "log_details", "agent", "ecs", "input" ]
  }
}

output {
  elasticsearch {
    hosts => ["https://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    index => "spring-logs-%{+YYYY.MM.dd}"
    cacert => "/usr/share/logstash/config/certs/ca/ca.crt"
    ssl => true
    ssl_certificate_verification => true
    template_name => "spring-logs"
    template_pattern => "spring-logs-*"
    template => {
      "index_patterns" => ["spring-logs-*"]
      "settings" => {
        "number_of_shards" => 1
        "number_of_replicas" => 0
        "index.lifecycle.name" => "spring-logs-policy"
        "index.lifecycle.rollover_alias" => "spring-logs"
      }
      "mappings" => {
        "properties" => {
          "@timestamp" => { "type" => "date" }
          "log_level" => { "type" => "keyword" }
          "application_name" => { "type" => "keyword" }
          "environment" => { "type" => "keyword" }
          "hostname" => { "type" => "keyword" }
          "formatted_message" => { "type" => "text" }
          "thread_name" => { "type" => "keyword" }
          "logger_name" => { "type" => "keyword" }
        }
      }
    }
  }
  
  # Debug için stdout (production'da kaldırılabilir)
  # stdout { codec => rubydebug }
}